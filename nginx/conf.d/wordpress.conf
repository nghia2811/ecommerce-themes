server {
    listen 80;
    server_name _;

    root /var/www/html;
    index index.php index.html index.htm;

    charset utf-8;

    # ── Connection Limit ──────────────────────────────────────
    limit_conn addr 20;

    # ── FastCGI Cache Variables ───────────────────────────────
    set $skip_cache 0;

    # Do NOT cache POST requests or URLs with query strings
    if ($request_method = POST)       { set $skip_cache 1; }
    if ($query_string != "")          { set $skip_cache 1; }

    # Do NOT cache WooCommerce dynamic pages
    if ($request_uri ~* "(/cart|/checkout|/my-account|/addons|/wp-admin|/wp-login.php)") {
        set $skip_cache 1;
    }

    # Do NOT cache logged-in users or commenters
    if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in|woocommerce_cart_hash|woocommerce_items_in_cart") {
        set $skip_cache 1;
    }

    # ── SEO Friendly URLs (WordPress Permalink) ───────────────
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ── PHP Processing ────────────────────────────────────────
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000;
        fastcgi_index index.php;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO       $fastcgi_path_info;

        # Timeouts for large file processing
        fastcgi_read_timeout   300s;
        fastcgi_send_timeout   300s;
        fastcgi_connect_timeout 60s;

        # Buffer settings for PHP responses
        fastcgi_buffer_size          128k;
        fastcgi_buffers              256 16k;
        fastcgi_busy_buffers_size    256k;
        fastcgi_temp_file_write_size 256k;

        # FastCGI Cache
        fastcgi_cache_bypass  $skip_cache;
        fastcgi_no_cache      $skip_cache;
        fastcgi_cache         WORDPRESS_CACHE;
        fastcgi_cache_valid   200 60m;
        fastcgi_cache_valid   301 302 10m;
        add_header X-FastCGI-Cache $upstream_cache_status;
    }

    # ── WordPress Admin Protection ────────────────────────────
    location /wp-admin {
        try_files $uri $uri/ /index.php?$args;

        # Rate-limit admin login page
        location = /wp-admin/admin-ajax.php {
            fastcgi_pass php:9000;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }

    # ── WP Login: Rate Limiting ───────────────────────────────
    location = /wp-login.php {
        limit_req zone=wp_login burst=3 nodelay;
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_read_timeout 60s;
    }

    # ── WP REST API: Rate Limiting ────────────────────────────
    location ~ ^/wp-json/ {
        limit_req zone=wp_api burst=50 nodelay;
        try_files $uri $uri/ /index.php?$args;
    }

    # ═══════════════════════════════════════════════════════════
    # SECURITY: Uploads Directory
    # Block PHP execution in uploads to prevent malware execution
    # ═══════════════════════════════════════════════════════════
    location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
        return 403;
    }

    # Block direct access to potentially dangerous file types in uploads
    location ~* /uploads/.*\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi|exe|bat)$ {
        deny all;
        return 403;
    }

    # ── Security: Sensitive Files ─────────────────────────────
    # Block access to hidden files/directories (e.g. .env, .git)
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block xmlrpc.php (brute-force vector)
    location = /xmlrpc.php {
        deny all;
        return 403;
    }

    # Block access to wp-config.php
    location = /wp-config.php {
        deny all;
        return 403;
    }

    # Block wp-includes PHP files directly (except wp-tinymce.php)
    location ~* ^/wp-includes/.*\.php$ {
        deny all;
        return 403;
    }

    # ── Static Assets: Long Cache + No Logging ────────────────
    location ~* \.(js|css|png|jpg|jpeg|gif|webp|svg|ico|woff|woff2|ttf|eot|otf|mp4|webm|pdf|zip)$ {
        expires     1y;
        add_header  Cache-Control "public, immutable";
        add_header  Vary "Accept-Encoding";
        access_log  off;
        log_not_found off;
    }

    # ── WooCommerce: Protect Digital Product Downloads ────────
    # Downloads are served via WordPress handler, not directly
    location ^~ /wp-content/uploads/woocommerce_uploads/ {
        internal;  # Only accessible via X-Accel-Redirect from PHP
    }

    # ── Health Check Endpoint ─────────────────────────────────
    location = /healthz {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # ── Security Headers ──────────────────────────────────────
    add_header X-Frame-Options           "SAMEORIGIN"   always;
    add_header X-Content-Type-Options    "nosniff"      always;
    add_header X-XSS-Protection          "1; mode=block" always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy        "camera=(), microphone=(), geolocation=()" always;
}
